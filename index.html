<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªöP SENSEI NGA - VIP SYSTEM</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #bc002d; --gold: #d4af37; --bg: #f4f7f6; --card: #ffffff; --text: #2c3e50; }
        body.dark-mode { --bg: #1a1a1a; --card: #2d2d2d; --text: #e0e0e0; }
        body { font-family: 'Noto Sans JP', sans-serif; background: var(--bg); color: var(--text); transition: 0.3s; margin: 0; padding-bottom: 50px; }
        
        .header { background: var(--card); padding: 20px; text-align: center; border-bottom: 5px solid var(--primary); position: relative; }
        .container { width: 95%; max-width: 500px; margin: auto; }
        .card { background: var(--card); border-radius: 15px; padding: 20px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Quiz Styles */
        .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-quiz { background: #3498db; color: white; padding: 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .option-btn { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; background: var(--card); color: var(--text); cursor: pointer; text-align: left; }
        
        /* Stats Styles */
        .score-big { font-size: 45px; color: var(--primary); font-weight: bold; text-align: center; }
        .coin-box { background: linear-gradient(135deg, #ffd700, #f1c40f); color: #000; padding: 15px; border-radius: 15px; text-align: center; font-weight: bold; margin-bottom: 10px; }
        
        /* Leaderboard */
        .leaderboard-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .rank-gold { color: #ffd700; font-weight: bold; }
        
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        .btn-main { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .hidden { display: none; }
        .dark-mode-toggle { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 20px; }
    </style>
</head>
<body>

<header class="header">
    <div class="dark-mode-toggle" onclick="toggleDarkMode()"><i class="fas fa-adjust"></i></div>
    <div style="font-size: 30px; font-weight: 900; color: var(--primary);">MVP</div>
    <h1 style="margin:0; font-size: 24px;">L·ªöP SENSEI NGA</h1>
</header>

<div class="container">
    <div id="login-section" class="card">
        <h3 style="text-align:center">ƒêƒÇNG NH·∫¨P H·ªÜ TH·ªêNG</h3>
        <input type="email" id="email" placeholder="Email (abc@gmail.com)">
        <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
        <button class="btn-main" onclick="handleLogin()">V√ÄO L·ªöP</button>
    </div>

    <div id="main-section" class="hidden">
        
        <div id="student-view" class="hidden">
            <div class="coin-box">
                <i class="fas fa-coins"></i> KHO XU MANTEN: <span id="mantenCoins">0</span> XU
            </div>
            <div class="card">
                <p style="text-align:center; margin:0;">ƒêi·ªÉm Man T√≠ch L≈©y</p>
                <div class="score-big" id="totalPoints">0</div>
                <hr>
                <div class="quiz-grid">
                    <button class="btn-quiz" onclick="loadQuiz('T·ª´ V·ª±ng')">T·ª´ V·ª±ng</button>
                    <button class="btn-quiz" onclick="loadQuiz('Kanji')">Kanji</button>
                    <button class="btn-quiz" onclick="loadQuiz('Ng·ªØ Ph√°p')">Ng·ªØ Ph√°p</button>
                    <button class="btn-quiz" onclick="loadQuiz('Chuy√™n Ng√†nh')">Chuy√™n Ng√†nh</button>
                </div>
            </div>
        </div>

        <div id="quiz-section" class="card hidden">
            <h3 id="quiz-title">M√¥n h·ªçc</h3>
            <div id="question-area">
                <p id="question-text" style="font-weight:bold; font-size:18px;"></p>
                <div id="options-area"></div>
            </div>
            <button onclick="closeQuiz()" style="background:#95a5a6; margin-top:10px;">Tho√°t</button>
        </div>

        <div class="card">
            <h3><i class="fas fa-crown"></i> CHI·∫æN TH·∫¶N MANTEN</h3>
            <div id="leaderboard-list"></div>
        </div>

        <div id="admin-view" class="hidden">
            <div class="card" style="border-top: 5px solid var(--gold);">
                <h3>DUY·ªÜT Y√äU C·∫¶U & ƒêI·ªÇM</h3>
                <div id="admin-control-list"></div>
            </div>
        </div>

        <button onclick="location.reload()" style="background:#7f8c8d; margin-top:20px;">ƒêƒÇNG XU·∫§T</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

<script>
    // --- 1. CONFIG (NAM THAY ·ªû ƒê√ÇY) ---
    const firebaseConfig = { apiKey: "...", authDomain: "...", projectId: "...", storageBucket: "...", messagingSenderId: "...", appId: "..." };
    const TELE_TOKEN = "TOKEN_BOT";
    const CHAT_ID = "CHAT_ID";

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentQuestions = [];
    let currentStep = 0;
    let score = 0;
    let currentSubject = "";

    // --- 2. LOGIC ƒêƒÇNG NH·∫¨P ---
    async function handleLogin() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        try {
            const res = await auth.signInWithEmailAndPassword(e, p);
            initApp(res.user.uid);
        } catch (err) { alert("L·ªói ƒëƒÉng nh·∫≠p l·ªõp Sensei Nga!"); }
    }

    async function initApp(uid) {
        const userDoc = await db.collection("users").doc(uid).get();
        const data = userDoc.data();
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('main-section').classList.remove('hidden');

        if (data.role === 'teacher') {
            document.getElementById('admin-view').classList.remove('hidden');
            loadAdminData();
        } else {
            document.getElementById('student-view').classList.remove('hidden');
            // Listen ƒëi·ªÉm real-time
            db.collection("users").doc(uid).onSnapshot(doc => {
                document.getElementById('totalPoints').innerText = doc.data().totalPoints;
                document.getElementById('mantenCoins').innerText = doc.data().mantenCoins || 0;
            });
        }
        loadLeaderboard();
    }

    // --- 3. H·ªÜ TH·ªêNG QUIZ (MANTEN HO·∫∂C KH√îNG) ---
    const quizData = {
        "T·ª´ V·ª±ng": [
            { q: "Ê®πËÑÇ l√† g√¨?", a: ["Nh·ª±a", "S·∫Øt", "G·ªó", "ƒê√°"], c: 0 },
            { q: "ÂÆâÂÖ® l√† g√¨?", a: ["Nguy hi·ªÉm", "An to√†n", "V·∫•t v·∫£", "Nhanh"], c: 1 }
        ],
        // Th√™m data Kanji, Ng·ªØ Ph√°p, Chuy√™n Ng√†nh t∆∞∆°ng t·ª±...
    };

    function loadQuiz(subject) {
        currentSubject = subject;
        currentQuestions = quizData[subject] || quizData["T·ª´ V·ª±ng"];
        currentStep = 0; score = 0;
        document.getElementById('student-view').classList.add('hidden');
        document.getElementById('quiz-section').classList.remove('hidden');
        showQuestion();
    }

    function showQuestion() {
        const q = currentQuestions[currentStep];
        document.getElementById('quiz-title').innerText = currentSubject;
        document.getElementById('question-text').innerText = q.q;
        let html = '';
        q.a.forEach((opt, i) => {
            html += `<button class="option-btn" onclick="checkAnswer(${i})">${opt}</button>`;
        });
        document.getElementById('options-area').innerHTML = html;
    }

    function checkAnswer(idx) {
        if (idx === currentQuestions[currentStep].c) score++;
        currentStep++;
        if (currentStep < currentQuestions.length) showQuestion();
        else finishQuiz();
    }

    async function finishQuiz() {
        const total = currentQuestions.length;
        if (score === total) {
            const uid = auth.currentUser.uid;
            const userDoc = await db.collection("users").doc(uid).get();
            const name = userDoc.data().name;

            await db.collection("users").doc(uid).update({
                totalPoints: firebase.firestore.FieldValue.increment(10), // Th∆∞·ªüng 10ƒë
                mantenCoins: firebase.firestore.FieldValue.increment(1)  // Th∆∞·ªüng 1 Xu
            });

            sendTele(`üëë <b>MANTEN!</b>\nH·ªçc sinh: <b>${name}</b>\nM√¥n: ${currentSubject}\nTh∆∞·ªüng: +10ƒë & +1 XU ü™ô`);
            alert("MANTEN TUY·ªÜT ƒê·ªêI! B·∫°n nh·∫≠n ƒë∆∞·ª£c 1 Xu Manten v√† 10ƒë Man!");
        } else {
            alert(`K·∫øt qu·∫£: ${score}/${total}. Ch·ªâ c√≥ Manten m·ªõi ƒë∆∞·ª£c th∆∞·ªüng! H√£y th·ª≠ l·∫°i.`);
        }
        closeQuiz();
    }

    function closeQuiz() {
        document.getElementById('quiz-section').classList.add('hidden');
        document.getElementById('student-view').classList.remove('hidden');
    }

    // --- 4. B·∫¢NG X·∫æP H·∫†NG ---
    function loadLeaderboard() {
        db.collection("users").where("role", "==", "student").orderBy("mantenCoins", "desc").limit(5).onSnapshot(snap => {
            let html = '';
            let i = 1;
            snap.forEach(doc => {
                const s = doc.data();
                html += `<div class="leaderboard-item">
                    <b style="width:30px">${i === 1 ? 'ü•á' : i}</b>
                    <div style="flex:1"><b>${s.name}</b><br><small>${s.mantenCoins || 0} l·∫ßn Manten ü™ô</small></div>
                    <div style="color:var(--primary)">${s.totalPoints}ƒë</div>
                </div>`;
                i++;
            });
            document.getElementById('leaderboard-list').innerHTML = html;
        });
    }

    // --- 5. TELEGRAM & DARKMODE ---
    async function sendTele(msg) {
        const url = `https://api.telegram.org/bot${TELE_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(msg)}&parse_mode=HTML`;
        fetch(url);
    }

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
    }
</script>
</body>
</html>
