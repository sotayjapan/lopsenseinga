<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ Thống Mail Vĩnh Viễn - Mail.tm API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .active-mail { border-left: 4px solid #2563eb; background: #eff6ff; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen p-4">

<div class="max-w-5xl mx-auto">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-blue-400">PRO MAIL SYSTEM</h1>
        <p class="text-slate-400">Mail vĩnh viễn có tài khoản & mật khẩu</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-slate-800 p-6 rounded-xl shadow-xl border border-slate-700">
            <button onclick="createNewAccount()" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-bold mb-4 transition">
                Tạo Mail Mới Ngẫu Nhiên
            </button>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-slate-500 uppercase">Địa chỉ mail hiện tại</label>
                    <div class="flex gap-2">
                        <input id="currentEmail" readonly class="w-full bg-slate-900 border border-slate-700 p-2 rounded text-sm text-blue-300">
                        <button onclick="copy('currentEmail')" class="bg-slate-700 px-3 rounded">Copy</button>
                    </div>
                </div>
                <div>
                    <label class="text-xs text-slate-500 uppercase">Mật khẩu (Để đăng nhập lại)</label>
                    <input id="currentPass" readonly class="w-full bg-slate-900 border border-slate-700 p-2 rounded text-sm">
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-slate-700">
                <h3 class="text-sm font-bold mb-3">Đăng nhập tài khoản cũ</h3>
                <input id="loginUser" placeholder="Email..." class="w-full bg-slate-900 border border-slate-700 p-2 rounded mb-2 text-sm">
                <input id="loginPass" type="password" placeholder="Mật khẩu..." class="w-full bg-slate-900 border border-slate-700 p-2 rounded mb-2 text-sm">
                <button onclick="login()" class="w-full bg-slate-700 hover:bg-slate-600 py-2 rounded text-sm transition">Đăng nhập</button>
            </div>
        </div>

        <div class="bg-slate-800 rounded-xl shadow-xl border border-slate-700 flex flex-col h-[600px]">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <span class="font-bold">Hộp thư đến</span>
                <button onclick="fetchMessages()" class="text-blue-400 text-sm hover:underline">Làm mới</button>
            </div>
            <div id="msgList" class="flex-1 overflow-y-auto p-2 space-y-2">
                </div>
        </div>

        <div class="bg-slate-800 rounded-xl shadow-xl border border-slate-700 h-[600px] flex flex-col">
            <div class="p-4 border-b border-slate-700 font-bold">Nội dung chi tiết</div>
            <div id="msgContent" class="flex-1 overflow-y-auto p-6 text-slate-300">
                <p class="text-slate-500 italic">Chọn một thư để đọc...</p>
            </div>
        </div>
    </div>
</div>

<script>
    const API = "https://api.mail.tm";
    let token = "";

    async function createNewAccount() {
        // 1. Lấy domain khả dụng
        const domains = await fetch(`${API}/domains`).then(r => r.json());
        const domain = domains["hydra:member"][0].domain;
        
        // 2. Tạo thông tin
        const user = `user${Math.floor(Math.random()*999999)}@${domain}`;
        const pass = "Pass123456@";

        const res = await fetch(`${API}/accounts`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({address: user, password: pass})
        });

        if(res.ok) {
            document.getElementById('currentEmail').value = user;
            document.getElementById('currentPass').value = pass;
            await login(user, pass);
        } else {
            alert("Lỗi tạo tài khoản, hãy thử lại!");
        }
    }

    async function login(u, p) {
        const user = u || document.getElementById('loginUser').value;
        const pass = p || document.getElementById('loginPass').value;

        const res = await fetch(`${API}/token`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({address: user, password: pass})
        });

        const data = await res.json();
        if(data.token) {
            token = data.token;
            alert("Đăng nhập thành công!");
            fetchMessages();
        } else {
            alert("Sai thông tin!");
        }
    }

    async function fetchMessages() {
        if(!token) return;
        const res = await fetch(`${API}/messages`, {
            headers: {'Authorization': `Bearer ${token}`}
        });
        const data = await res.json();
        const list = data["hydra:member"];
        
        const html = list.map(m => `
            <div onclick="readMail('${m.id}')" class="p-3 rounded bg-slate-900 border border-slate-700 cursor-pointer hover:border-blue-500 transition">
                <div class="text-xs text-blue-400 font-bold mb-1">${m.from.address}</div>
                <div class="text-sm truncate font-medium">${m.subject}</div>
            </div>
        `).join('');
        document.getElementById('msgList').innerHTML = html || "Chưa có thư...";
    }

    async function readMail(id) {
        document.getElementById('msgContent').innerHTML = "Đang tải...";
        const res = await fetch(`${API}/messages/${id}`, {
            headers: {'Authorization': `Bearer ${token}`}
        });
        const data = await res.json();
        document.getElementById('msgContent').innerHTML = `
            <div class="mb-4 pb-4 border-b border-slate-700">
                <h2 class="text-xl font-bold text-white">${data.subject}</h2>
                <p class="text-sm text-slate-400">Từ: ${data.from.address}</p>
            </div>
            <div class="mail-body bg-white text-black p-4 rounded">
                ${data.html ? data.html[0] : data.intro}
            </div>
        `;
    }

    function copy(id) {
        const val = document.getElementById(id).value;
        navigator.clipboard.writeText(val);
    }
</script>
</body>
</html>
